---
title: "Visualization Pro"
author: "Ilia Popov"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### **1) Preparation**

1st step - install or call libraries

```{r libraries, message=FALSE, warning=FALSE}
if (!require("pacman")) install.packages("pacman")

pacman::p_load(ggplot2, ggtree, phangorn, treeio, ggnewscale, viridis)
```

2nd step - set the working directory

```{r}
main_dir <- dirname(rstudioapi::getSourceEditorContext()$path)
setwd(main_dir)
```

### **2) Initial visualization**

Create a directory for images

```{r}
dir.create("imgs", showWarnings = TRUE, recursive = FALSE, mode = "0777")
```

As we remember from the previous laboratory journal our tree file is in `Newick` format and it was created with `IQ-TREE`. Also, there are bootstrap values in our tree files. That is why it is better to read the tree with `read.iqtree` function instead of default `read.tree` function.

So let us read the tree, midpoint root it and make the 1st visualization.

```{r}
#Read the tree
vshv.tree <- read.iqtree('data/iqtree/vhsv.treefile')

#Midpoint root the tree
vshv.tree@phylo <- midpoint(vshv.tree@phylo)

#Display the tree
plot(vshv.tree@phylo)

#And let's save the tree
png(filename="imgs/1st_tree.png")
plot(vshv.tree@phylo)
dev.off()
```

Um. Okay, but nothing special! There is a lot of work ahead to make this tree pretty!

### **3) Adding host information to the tree**

Now we will read the metadata and add the host information to the tree. To do so we will use the `%<+%` sign, which allow us to use different columns of the metadata to decorate different parts of the tree.

Let's add host information to the tip points

```{r}
#Read the metadata
meta <- read.table('data/metadata.csv', sep=',', header=T)

#Plot the tree and add host information from the metadata to the tree's tip points
tree_2 <- ggtree(vshv.tree) %<+% meta +
  geom_tippoint(aes(color=Host))

#Display the tree
tree_2
```

And let's save the tree

```{r}
ggsave("imgs/2nd_tree.png", tree_2, dpi = 600)
```

### **4) Use the circular layout and add bootstrap information**

`IQ-TREE` Newick file contains a bootstrap support value which has both `SH_aLRT` and `UFboot` values. Let's show branches that has high support for both of parameters (i.e. ≥ 70).

When we define a `ggtree` object using `tree_3 <- ggtree(vshv.tree) %<+% meta + geom_tippoint(aes(color=Host))`, it attaches the metadata as well as tree-branch and tips info coming from original Newick tree-file in the data placeholder, which we can use by `tree_3$data`. So let’s update this to have a new column of a variable that satisfy both bootstrap values:

```{r}
#Use the circular layout for the tree
tree_3 <- ggtree(vshv.tree, layout="circular") %<+% meta +
  geom_tippoint(aes(color=Host))

#Create a new parameter `bootstrap` with the default value of 0
tree_3$data$bootstrap <- '0'

#Assign value 1 to the tree branches that has both SH_aLRT and UFboot values higher than 70
tree_3$data[which(tree_3$data$SH_aLRT >= 70 & tree_3$data$UFboot  >= 70),]$bootstrap <- '1'

#Plot the tree and use "black" color for branches with bootstrap value = 1 (>=70) and "grey" color for branches with bootstrap value = 0 (<70)
tree_3 <- tree_3 + new_scale_color() +
  geom_tree(aes(color=bootstrap == '1')) +
  scale_color_manual(name='Bootstrap', values=setNames(c("black", "grey"), c(T,F)), guide = "none")

#Display the tree
tree_3
```

And let's save the tree

```{r}
ggsave("imgs/3rd_tree.png", tree_3, dpi = 600)
```

### **5) Add the last metadata info as the heatmaps and make the final visualization**

Create two separate dataframes for `Water` and `Year` and parse them to make further visualize much more convenient

```{r}
#Read Water column from metadata to a separate dataframe
meta.water <- as.data.frame(meta[,'Water'])
#Change column name from `meta[,'Water']` to `Water`
colnames(meta.water) <- 'Water'
#Change row names from `1, 2, 3, ...` to strains `AU-8-95, CH-FI262BFH, ...`
rownames(meta.water) <- meta$Strain

#Read Year column from metadata to a separate dataframe
meta.year <- as.data.frame(meta[,'Year'])
##Change column name from `meta[,'Year']` to `Year`
colnames(meta.year) <- 'Year'
#Change row names from `1, 2, 3, ...` to strains `AU-8-95, CH-FI262BFH, ...`
rownames(meta.year) <- meta$Strain
```



```{r}
#Create a new tree that uses the previous tree (circular layout + host info at the tip points)
#Add `meta.water` dataframe as the heatmap and set the width to 0.2 and offset to 0.01
#Use `viridis` "A" colormap and name legend title "Water"
final_tree <- gheatmap(tree_3, meta.water, width=0.2, offset=0.01) + 
  scale_fill_viridis_d(option="A", name="Water") +
  new_scale_fill() #define a new fill scale using after the first gheatmap, for the second gheatmap to draw upon

#Create a new tree that uses the tree created above
#Add `meta.year` dataframe as the heatmap and set the width to 0.1 and offset to 0.05
#Use `viridis` "D" colormap and name legend title "Year"
final_tree <- gheatmap(final_tree, meta.year, width=0.1, offset=0.05) + 
  scale_fill_viridis(option="D", name="Year")
```

Add the country information from the metadata to the tip labels and plot the final tree!

```{r}
#Add the country information to the tip labels, set the color to "gray40", offset to 0.03 and size to 3
final_tree <- final_tree + geom_tiplab2(aes(label=Country), color="gray40", offset=0.003, size=3)

#Display the tree
final_tree
```

And let's save the tree

```{r}
ggsave("imgs/final_tree.png", final_tree, width = 10, height = 8, dpi = 600)
```